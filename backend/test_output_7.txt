============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\19803\business\FactoryExcelManager\backend\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\19803\business\FactoryExcelManager\backend
configfile: pytest.ini
plugins: anyio-4.12.1, Faker-40.1.0, langsmith-0.6.1, asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/test_sequential_ingestion.py::test_jan_feb_march_continuity --- Created Test Data Source: 7c8bdad3-d879-4063-b1ee-a320628a221f ---
--- Uploading Jan.xlsx ---
{"timestamp": "2026-01-09T20:18:17.906019Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/upload?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9&data_source_id=7c8bdad3-d879-4063-b1ee-a320628a221f \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-01-09T20:18:18.149713Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'Date' -> 'production_date' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:18.150034Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Fuzzy]: 'Units Produced' -> 'actual_qty' (Score: 90)"}
{"timestamp": "2026-01-09T20:18:18.150106Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'Efficiency' -> 'line_efficiency' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:18.150148Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'Style' -> 'style_number' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:18.150191Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'PO' -> 'po_number' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:18.163908Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/process/bee8f5eb-bdbd-4a44-b887-0befa8c375ad?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9 \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-01-09T20:18:18.165405Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:18.165472Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "CONFIRM-MAPPING ENDPOINT CALLED"}
{"timestamp": "2026-01-09T20:18:18.165505Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  raw_import_id: bee8f5eb-bdbd-4a44-b887-0befa8c375ad"}
{"timestamp": "2026-01-09T20:18:18.165538Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  production_line_id: None"}
{"timestamp": "2026-01-09T20:18:18.165572Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9"}
{"timestamp": "2026-01-09T20:18:18.165604Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f"}
{"timestamp": "2026-01-09T20:18:18.165647Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  mappings count: 4"}
{"timestamp": "2026-01-09T20:18:18.165679Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:18.174359Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/confirm-mapping \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-01-09T20:18:18.177488Z", "level": "INFO", "logger": "ingestion.promote", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:18.177571Z", "level": "INFO", "logger": "ingestion.promote", "message": "PROMOTE ENDPOINT CALLED"}
{"timestamp": "2026-01-09T20:18:18.177606Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import_id: bee8f5eb-bdbd-4a44-b887-0befa8c375ad"}
{"timestamp": "2026-01-09T20:18:18.177636Z", "level": "INFO", "logger": "ingestion.promote", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:18.181988Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.status: confirmed"}
{"timestamp": "2026-01-09T20:18:18.182056Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9"}
{"timestamp": "2026-01-09T20:18:18.182089Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.production_line_id: None"}
{"timestamp": "2026-01-09T20:18:18.182119Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f"}
{"timestamp": "2026-01-09T20:18:18.182149Z", "level": "INFO", "logger": "ingestion.promote", "message": "Creating FileProcessingService..."}
{"timestamp": "2026-01-09T20:18:18.182216Z", "level": "INFO", "logger": "ingestion.promote", "message": "Calling promote_to_production..."}
{"timestamp": "2026-01-09T20:18:18.182300Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "ORCHESTRATOR: promote_to_production for bee8f5eb-bdbd-4a44-b887-0befa8c375ad"}
{"timestamp": "2026-01-09T20:18:18.190897Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "DEBUG: Checking mappings for DS 7c8bdad3-d879-4063-b1ee-a320628a221f"}
{"timestamp": "2026-01-09T20:18:18.190996Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "DEBUG: Mapping 20bcf919-affb-4a48-ac95-0c3c8d62c093 | Ver: 1 | Active: True"}
{"timestamp": "2026-01-09T20:18:18.210059Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "Resolving existing runs for differential calculation..."}
{"timestamp": "2026-01-09T20:18:18.212381Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "Found 0 existing runs to update."}
{"timestamp": "2026-01-09T20:18:18.212932Z", "level": "INFO", "logger": "app.services.ingestion.writer", "message": "Inserting 31 new runs..."}
{"timestamp": "2026-01-09T20:18:18.218819Z", "level": "INFO", "logger": "app.services.ingestion.writer", "message": "Inserting 31 events..."}
{"timestamp": "2026-01-09T20:18:19.295359Z", "level": "WARNING", "logger": "app.core.cache", "message": "Redis unavailable: Timeout connecting to server. Cache will be bypassed."}
{"timestamp": "2026-01-09T20:18:19.295536Z", "level": "INFO", "logger": "ingestion.promote", "message": "Promotion SUCCESS: {'status': 'promoted', 'inserted': 31, 'updated': 0, 'events': 31, 'errors': 0}"}
{"timestamp": "2026-01-09T20:18:19.295897Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/promote/bee8f5eb-bdbd-4a44-b887-0befa8c375ad \"HTTP/1.1 200 OK\""}
--- Uploading Feb.xlsx ---
{"timestamp": "2026-01-09T20:18:19.356155Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/upload?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9&data_source_id=7c8bdad3-d879-4063-b1ee-a320628a221f \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-01-09T20:18:19.855589Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'Date' -> 'production_date' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:19.856183Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Fuzzy]: 'Units Produced' -> 'actual_qty' (Score: 90)"}
{"timestamp": "2026-01-09T20:18:19.856383Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'Efficiency' -> 'line_efficiency' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:19.856559Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'Style' -> 'style_number' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:19.856725Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'PO' -> 'po_number' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:19.878394Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/process/0013451d-c8d2-4e98-be46-c21bbfd50d2e?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9 \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-01-09T20:18:19.879278Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:19.879384Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "CONFIRM-MAPPING ENDPOINT CALLED"}
{"timestamp": "2026-01-09T20:18:19.879475Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  raw_import_id: 0013451d-c8d2-4e98-be46-c21bbfd50d2e"}
{"timestamp": "2026-01-09T20:18:19.879563Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  production_line_id: None"}
{"timestamp": "2026-01-09T20:18:19.879652Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9"}
{"timestamp": "2026-01-09T20:18:19.879727Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f"}
{"timestamp": "2026-01-09T20:18:19.879804Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  mappings count: 4"}
{"timestamp": "2026-01-09T20:18:19.879879Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:19.889653Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/confirm-mapping \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-01-09T20:18:19.894724Z", "level": "INFO", "logger": "ingestion.promote", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:19.894870Z", "level": "INFO", "logger": "ingestion.promote", "message": "PROMOTE ENDPOINT CALLED"}
{"timestamp": "2026-01-09T20:18:19.894970Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import_id: 0013451d-c8d2-4e98-be46-c21bbfd50d2e"}
{"timestamp": "2026-01-09T20:18:19.895057Z", "level": "INFO", "logger": "ingestion.promote", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:19.896274Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.status: confirmed"}
{"timestamp": "2026-01-09T20:18:19.896383Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9"}
{"timestamp": "2026-01-09T20:18:19.896469Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.production_line_id: None"}
{"timestamp": "2026-01-09T20:18:19.896550Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f"}
{"timestamp": "2026-01-09T20:18:19.896628Z", "level": "INFO", "logger": "ingestion.promote", "message": "Creating FileProcessingService..."}
{"timestamp": "2026-01-09T20:18:19.896787Z", "level": "INFO", "logger": "ingestion.promote", "message": "Calling promote_to_production..."}
{"timestamp": "2026-01-09T20:18:19.896996Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "ORCHESTRATOR: promote_to_production for 0013451d-c8d2-4e98-be46-c21bbfd50d2e"}
{"timestamp": "2026-01-09T20:18:19.919021Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "DEBUG: Checking mappings for DS 7c8bdad3-d879-4063-b1ee-a320628a221f"}
{"timestamp": "2026-01-09T20:18:19.919163Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "DEBUG: Mapping 20bcf919-affb-4a48-ac95-0c3c8d62c093 | Ver: 1 | Active: False"}
{"timestamp": "2026-01-09T20:18:19.919253Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "DEBUG: Mapping cb0f280c-16e1-42ef-a38b-21a3335effa9 | Ver: 2 | Active: True"}
{"timestamp": "2026-01-09T20:18:20.083358Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "Resolving existing runs for differential calculation..."}
{"timestamp": "2026-01-09T20:18:20.085311Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "Found 0 existing runs to update."}
{"timestamp": "2026-01-09T20:18:20.086430Z", "level": "INFO", "logger": "app.services.ingestion.writer", "message": "Inserting 29 new runs..."}
{"timestamp": "2026-01-09T20:18:20.096222Z", "level": "INFO", "logger": "app.services.ingestion.writer", "message": "Inserting 29 events..."}
{"timestamp": "2026-01-09T20:18:21.165674Z", "level": "WARNING", "logger": "app.core.cache", "message": "Redis unavailable: Timeout connecting to server. Cache will be bypassed."}
{"timestamp": "2026-01-09T20:18:21.166164Z", "level": "INFO", "logger": "ingestion.promote", "message": "Promotion SUCCESS: {'status': 'promoted', 'inserted': 29, 'updated': 0, 'events': 29, 'errors': 0}"}
{"timestamp": "2026-01-09T20:18:21.166875Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/promote/0013451d-c8d2-4e98-be46-c21bbfd50d2e \"HTTP/1.1 200 OK\""}
--- Uploading Mar.xlsx ---
{"timestamp": "2026-01-09T20:18:21.219447Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/upload?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9&data_source_id=7c8bdad3-d879-4063-b1ee-a320628a221f \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-01-09T20:18:21.641220Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'Date' -> 'production_date' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:21.641962Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Fuzzy]: 'Units Produced' -> 'actual_qty' (Score: 90)"}
{"timestamp": "2026-01-09T20:18:21.642169Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'Efficiency' -> 'line_efficiency' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:21.642469Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'Style' -> 'style_number' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:21.642675Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'PO' -> 'po_number' (Conf: 1.0)"}
{"timestamp": "2026-01-09T20:18:21.667645Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/process/9fb4d45d-5956-485d-a2be-d29ab11626f5?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9 \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-01-09T20:18:21.668619Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:21.668726Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "CONFIRM-MAPPING ENDPOINT CALLED"}
{"timestamp": "2026-01-09T20:18:21.668809Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  raw_import_id: 9fb4d45d-5956-485d-a2be-d29ab11626f5"}
{"timestamp": "2026-01-09T20:18:21.668885Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  production_line_id: None"}
{"timestamp": "2026-01-09T20:18:21.668954Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9"}
{"timestamp": "2026-01-09T20:18:21.669021Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f"}
{"timestamp": "2026-01-09T20:18:21.669087Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  mappings count: 4"}
{"timestamp": "2026-01-09T20:18:21.669149Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:21.679168Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/confirm-mapping \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-01-09T20:18:21.685232Z", "level": "INFO", "logger": "ingestion.promote", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:21.685380Z", "level": "INFO", "logger": "ingestion.promote", "message": "PROMOTE ENDPOINT CALLED"}
{"timestamp": "2026-01-09T20:18:21.685469Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import_id: 9fb4d45d-5956-485d-a2be-d29ab11626f5"}
{"timestamp": "2026-01-09T20:18:21.685545Z", "level": "INFO", "logger": "ingestion.promote", "message": "============================================================"}
{"timestamp": "2026-01-09T20:18:21.686629Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.status: confirmed"}
{"timestamp": "2026-01-09T20:18:21.686737Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9"}
{"timestamp": "2026-01-09T20:18:21.686813Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.production_line_id: None"}
{"timestamp": "2026-01-09T20:18:21.686882Z", "level": "INFO", "logger": "ingestion.promote", "message": "  raw_import.data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f"}
{"timestamp": "2026-01-09T20:18:21.686952Z", "level": "INFO", "logger": "ingestion.promote", "message": "Creating FileProcessingService..."}
{"timestamp": "2026-01-09T20:18:21.687084Z", "level": "INFO", "logger": "ingestion.promote", "message": "Calling promote_to_production..."}
{"timestamp": "2026-01-09T20:18:21.687280Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "ORCHESTRATOR: promote_to_production for 9fb4d45d-5956-485d-a2be-d29ab11626f5"}
{"timestamp": "2026-01-09T20:18:21.708909Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "DEBUG: Checking mappings for DS 7c8bdad3-d879-4063-b1ee-a320628a221f"}
{"timestamp": "2026-01-09T20:18:21.709082Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "DEBUG: Mapping 20bcf919-affb-4a48-ac95-0c3c8d62c093 | Ver: 1 | Active: False"}
{"timestamp": "2026-01-09T20:18:21.709184Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "DEBUG: Mapping cb0f280c-16e1-42ef-a38b-21a3335effa9 | Ver: 2 | Active: False"}
{"timestamp": "2026-01-09T20:18:21.709275Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "DEBUG: Mapping 40741b17-6e07-4f34-807d-22ece891e0a8 | Ver: 3 | Active: True"}
{"timestamp": "2026-01-09T20:18:21.754020Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "Resolving existing runs for differential calculation..."}
{"timestamp": "2026-01-09T20:18:21.755649Z", "level": "INFO", "logger": "app.services.ingestion.orchestrator", "message": "Found 0 existing runs to update."}
{"timestamp": "2026-01-09T20:18:21.756882Z", "level": "INFO", "logger": "app.services.ingestion.writer", "message": "Inserting 31 new runs..."}
{"timestamp": "2026-01-09T20:18:21.769337Z", "level": "INFO", "logger": "app.services.ingestion.writer", "message": "Inserting 31 events..."}
{"timestamp": "2026-01-09T20:18:22.806747Z", "level": "WARNING", "logger": "app.core.cache", "message": "Redis unavailable: Timeout connecting to server. Cache will be bypassed."}
{"timestamp": "2026-01-09T20:18:22.806936Z", "level": "INFO", "logger": "ingestion.promote", "message": "Promotion SUCCESS: {'status': 'promoted', 'inserted': 31, 'updated': 0, 'events': 31, 'errors': 0}"}
{"timestamp": "2026-01-09T20:18:22.807366Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/promote/9fb4d45d-5956-485d-a2be-d29ab11626f5 \"HTTP/1.1 200 OK\""}
Total Rows: 91 (Expected: 91)
FAILED

================================== FAILURES ===================================
________________________ test_jan_feb_march_continuity ________________________
tests\test_sequential_ingestion.py:149: in test_jan_feb_march_continuity
    assert runs[-1].production_date.strftime("%Y-%m-%d") == "2024-03-31"
E   AssertionError: assert '2024-12-03' == '2024-03-31'
E     
E     - 2024-03-31
E     + 2024-12-03
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/upload?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9&data_source_id=7c8bdad3-d879-4063-b1ee-a320628a221f "HTTP/1.1 200 OK"
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'Date' -> 'production_date' (Conf: 1.0)
INFO     app.services.matching.engine:engine.py:171 MATCH [Fuzzy]: 'Units Produced' -> 'actual_qty' (Score: 90)
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'Efficiency' -> 'line_efficiency' (Conf: 1.0)
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'Style' -> 'style_number' (Conf: 1.0)
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'PO' -> 'po_number' (Conf: 1.0)
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/process/bee8f5eb-bdbd-4a44-b887-0befa8c375ad?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9 "HTTP/1.1 200 OK"
INFO     ingestion.confirm_mapping:ingestion.py:417 ============================================================
INFO     ingestion.confirm_mapping:ingestion.py:418 CONFIRM-MAPPING ENDPOINT CALLED
INFO     ingestion.confirm_mapping:ingestion.py:419   raw_import_id: bee8f5eb-bdbd-4a44-b887-0befa8c375ad
INFO     ingestion.confirm_mapping:ingestion.py:420   production_line_id: None
INFO     ingestion.confirm_mapping:ingestion.py:421   factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9
INFO     ingestion.confirm_mapping:ingestion.py:422   data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f
INFO     ingestion.confirm_mapping:ingestion.py:423   mappings count: 4
INFO     ingestion.confirm_mapping:ingestion.py:424 ============================================================
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/confirm-mapping "HTTP/1.1 200 OK"
INFO     ingestion.promote:ingestion.py:916 ============================================================
INFO     ingestion.promote:ingestion.py:917 PROMOTE ENDPOINT CALLED
INFO     ingestion.promote:ingestion.py:918   raw_import_id: bee8f5eb-bdbd-4a44-b887-0befa8c375ad
INFO     ingestion.promote:ingestion.py:919 ============================================================
INFO     ingestion.promote:ingestion.py:931   raw_import.status: confirmed
INFO     ingestion.promote:ingestion.py:932   raw_import.factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9
INFO     ingestion.promote:ingestion.py:933   raw_import.production_line_id: None
INFO     ingestion.promote:ingestion.py:934   raw_import.data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f
INFO     ingestion.promote:ingestion.py:944 Creating FileProcessingService...
INFO     ingestion.promote:ingestion.py:946 Calling promote_to_production...
INFO     app.services.ingestion.orchestrator:orchestrator.py:75 ORCHESTRATOR: promote_to_production for bee8f5eb-bdbd-4a44-b887-0befa8c375ad
INFO     app.services.ingestion.orchestrator:orchestrator.py:92 DEBUG: Checking mappings for DS 7c8bdad3-d879-4063-b1ee-a320628a221f
INFO     app.services.ingestion.orchestrator:orchestrator.py:95 DEBUG: Mapping 20bcf919-affb-4a48-ac95-0c3c8d62c093 | Ver: 1 | Active: True
INFO     app.services.ingestion.orchestrator:orchestrator.py:144 Resolving existing runs for differential calculation...
INFO     app.services.ingestion.orchestrator:orchestrator.py:148 Found 0 existing runs to update.
INFO     app.services.ingestion.writer:writer.py:312 Inserting 31 new runs...
INFO     app.services.ingestion.writer:writer.py:325 Inserting 31 events...
WARNING  app.core.cache:cache.py:50 Redis unavailable: Timeout connecting to server. Cache will be bypassed.
INFO     ingestion.promote:ingestion.py:948 Promotion SUCCESS: {'status': 'promoted', 'inserted': 31, 'updated': 0, 'events': 31, 'errors': 0}
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/promote/bee8f5eb-bdbd-4a44-b887-0befa8c375ad "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/upload?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9&data_source_id=7c8bdad3-d879-4063-b1ee-a320628a221f "HTTP/1.1 200 OK"
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'Date' -> 'production_date' (Conf: 1.0)
INFO     app.services.matching.engine:engine.py:171 MATCH [Fuzzy]: 'Units Produced' -> 'actual_qty' (Score: 90)
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'Efficiency' -> 'line_efficiency' (Conf: 1.0)
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'Style' -> 'style_number' (Conf: 1.0)
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'PO' -> 'po_number' (Conf: 1.0)
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/process/0013451d-c8d2-4e98-be46-c21bbfd50d2e?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9 "HTTP/1.1 200 OK"
INFO     ingestion.confirm_mapping:ingestion.py:417 ============================================================
INFO     ingestion.confirm_mapping:ingestion.py:418 CONFIRM-MAPPING ENDPOINT CALLED
INFO     ingestion.confirm_mapping:ingestion.py:419   raw_import_id: 0013451d-c8d2-4e98-be46-c21bbfd50d2e
INFO     ingestion.confirm_mapping:ingestion.py:420   production_line_id: None
INFO     ingestion.confirm_mapping:ingestion.py:421   factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9
INFO     ingestion.confirm_mapping:ingestion.py:422   data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f
INFO     ingestion.confirm_mapping:ingestion.py:423   mappings count: 4
INFO     ingestion.confirm_mapping:ingestion.py:424 ============================================================
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/confirm-mapping "HTTP/1.1 200 OK"
INFO     ingestion.promote:ingestion.py:916 ============================================================
INFO     ingestion.promote:ingestion.py:917 PROMOTE ENDPOINT CALLED
INFO     ingestion.promote:ingestion.py:918   raw_import_id: 0013451d-c8d2-4e98-be46-c21bbfd50d2e
INFO     ingestion.promote:ingestion.py:919 ============================================================
INFO     ingestion.promote:ingestion.py:931   raw_import.status: confirmed
INFO     ingestion.promote:ingestion.py:932   raw_import.factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9
INFO     ingestion.promote:ingestion.py:933   raw_import.production_line_id: None
INFO     ingestion.promote:ingestion.py:934   raw_import.data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f
INFO     ingestion.promote:ingestion.py:944 Creating FileProcessingService...
INFO     ingestion.promote:ingestion.py:946 Calling promote_to_production...
INFO     app.services.ingestion.orchestrator:orchestrator.py:75 ORCHESTRATOR: promote_to_production for 0013451d-c8d2-4e98-be46-c21bbfd50d2e
INFO     app.services.ingestion.orchestrator:orchestrator.py:92 DEBUG: Checking mappings for DS 7c8bdad3-d879-4063-b1ee-a320628a221f
INFO     app.services.ingestion.orchestrator:orchestrator.py:95 DEBUG: Mapping 20bcf919-affb-4a48-ac95-0c3c8d62c093 | Ver: 1 | Active: False
INFO     app.services.ingestion.orchestrator:orchestrator.py:95 DEBUG: Mapping cb0f280c-16e1-42ef-a38b-21a3335effa9 | Ver: 2 | Active: True
INFO     app.services.ingestion.orchestrator:orchestrator.py:144 Resolving existing runs for differential calculation...
INFO     app.services.ingestion.orchestrator:orchestrator.py:148 Found 0 existing runs to update.
INFO     app.services.ingestion.writer:writer.py:312 Inserting 29 new runs...
INFO     app.services.ingestion.writer:writer.py:325 Inserting 29 events...
WARNING  app.core.cache:cache.py:50 Redis unavailable: Timeout connecting to server. Cache will be bypassed.
INFO     ingestion.promote:ingestion.py:948 Promotion SUCCESS: {'status': 'promoted', 'inserted': 29, 'updated': 0, 'events': 29, 'errors': 0}
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/promote/0013451d-c8d2-4e98-be46-c21bbfd50d2e "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/upload?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9&data_source_id=7c8bdad3-d879-4063-b1ee-a320628a221f "HTTP/1.1 200 OK"
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'Date' -> 'production_date' (Conf: 1.0)
INFO     app.services.matching.engine:engine.py:171 MATCH [Fuzzy]: 'Units Produced' -> 'actual_qty' (Score: 90)
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'Efficiency' -> 'line_efficiency' (Conf: 1.0)
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'Style' -> 'style_number' (Conf: 1.0)
INFO     app.services.matching.engine:engine.py:163 MATCH [Hash]: 'PO' -> 'po_number' (Conf: 1.0)
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/process/9fb4d45d-5956-485d-a2be-d29ab11626f5?factory_id=6c676365-a287-4e62-ba47-f0c17f2c40d9 "HTTP/1.1 200 OK"
INFO     ingestion.confirm_mapping:ingestion.py:417 ============================================================
INFO     ingestion.confirm_mapping:ingestion.py:418 CONFIRM-MAPPING ENDPOINT CALLED
INFO     ingestion.confirm_mapping:ingestion.py:419   raw_import_id: 9fb4d45d-5956-485d-a2be-d29ab11626f5
INFO     ingestion.confirm_mapping:ingestion.py:420   production_line_id: None
INFO     ingestion.confirm_mapping:ingestion.py:421   factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9
INFO     ingestion.confirm_mapping:ingestion.py:422   data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f
INFO     ingestion.confirm_mapping:ingestion.py:423   mappings count: 4
INFO     ingestion.confirm_mapping:ingestion.py:424 ============================================================
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/confirm-mapping "HTTP/1.1 200 OK"
INFO     ingestion.promote:ingestion.py:916 ============================================================
INFO     ingestion.promote:ingestion.py:917 PROMOTE ENDPOINT CALLED
INFO     ingestion.promote:ingestion.py:918   raw_import_id: 9fb4d45d-5956-485d-a2be-d29ab11626f5
INFO     ingestion.promote:ingestion.py:919 ============================================================
INFO     ingestion.promote:ingestion.py:931   raw_import.status: confirmed
INFO     ingestion.promote:ingestion.py:932   raw_import.factory_id: 6c676365-a287-4e62-ba47-f0c17f2c40d9
INFO     ingestion.promote:ingestion.py:933   raw_import.production_line_id: None
INFO     ingestion.promote:ingestion.py:934   raw_import.data_source_id: 7c8bdad3-d879-4063-b1ee-a320628a221f
INFO     ingestion.promote:ingestion.py:944 Creating FileProcessingService...
INFO     ingestion.promote:ingestion.py:946 Calling promote_to_production...
INFO     app.services.ingestion.orchestrator:orchestrator.py:75 ORCHESTRATOR: promote_to_production for 9fb4d45d-5956-485d-a2be-d29ab11626f5
INFO     app.services.ingestion.orchestrator:orchestrator.py:92 DEBUG: Checking mappings for DS 7c8bdad3-d879-4063-b1ee-a320628a221f
INFO     app.services.ingestion.orchestrator:orchestrator.py:95 DEBUG: Mapping 20bcf919-affb-4a48-ac95-0c3c8d62c093 | Ver: 1 | Active: False
INFO     app.services.ingestion.orchestrator:orchestrator.py:95 DEBUG: Mapping cb0f280c-16e1-42ef-a38b-21a3335effa9 | Ver: 2 | Active: False
INFO     app.services.ingestion.orchestrator:orchestrator.py:95 DEBUG: Mapping 40741b17-6e07-4f34-807d-22ece891e0a8 | Ver: 3 | Active: True
INFO     app.services.ingestion.orchestrator:orchestrator.py:144 Resolving existing runs for differential calculation...
INFO     app.services.ingestion.orchestrator:orchestrator.py:148 Found 0 existing runs to update.
INFO     app.services.ingestion.writer:writer.py:312 Inserting 31 new runs...
INFO     app.services.ingestion.writer:writer.py:325 Inserting 31 events...
WARNING  app.core.cache:cache.py:50 Redis unavailable: Timeout connecting to server. Cache will be bypassed.
INFO     ingestion.promote:ingestion.py:948 Promotion SUCCESS: {'status': 'promoted', 'inserted': 31, 'updated': 0, 'events': 31, 'errors': 0}
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/promote/9fb4d45d-5956-485d-a2be-d29ab11626f5 "HTTP/1.1 200 OK"
=========================== short test summary info ===========================
FAILED tests/test_sequential_ingestion.py::test_jan_feb_march_continuity - As...
============================== 1 failed in 7.61s ==============================
