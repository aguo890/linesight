============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- C:\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\19803\Projects\FactoryExcelManager\backend
configfile: pytest.ini
plugins: anyio-4.12.0, Faker-40.1.0, langsmith-0.5.1, locust-2.43.0, asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 11 items

backend\tests\test_api\test_preview.py::test_preview_endpoint_success PASSED [  9%]
backend\tests\test_api\test_preview.py::test_list_uploads_includes_datasource_id FAILED [ 18%]
backend\tests\test_api\test_line_management.py::test_reset_schema_configuration FAILED [ 27%]
backend\tests\test_api\test_line_management.py::test_clear_upload_history FAILED [ 36%]
backend\tests\api\v1\test_users.py::test_get_user_me PASSED              [ 45%]
backend\tests\api\v1\test_users.py::test_update_user_me PASSED           [ 54%]
backend\tests\api\v1\test_users.py::test_update_user_invalid_timezone PASSED [ 63%]
backend\tests\api\v1\test_users.py::test_update_user_partial_preferences PASSED [ 72%]
backend\tests\api\v1\test_users.py::test_update_user_invalid_preference_type PASSED [ 81%]
backend\tests\api\test_analytics_flaws.py::test_hourly_production_no_events_returns_zeros PASSED [ 90%]
backend\tests\api\test_analytics_flaws.py::test_midnight_boundary_respects_timezone PASSED [100%]

================================== FAILURES ===================================
__________________ test_list_uploads_includes_datasource_id ___________________
backend\tests\test_api\test_preview.py:140: in test_list_uploads_includes_datasource_id
    assert ds_res.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-16T08:40:30.739790Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/upload?factory_id=df1aa679-af47-46f9-9ee7-1639e95aa989&production_line_id=f529f429-f93e-4c65-9347-dad986ccec2e \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-02-16T08:40:30.741460Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "============================================================"}
{"timestamp": "2026-02-16T08:40:30.741528Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "CONFIRM-MAPPING ENDPOINT CALLED"}
{"timestamp": "2026-02-16T08:40:30.741562Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  raw_import_id: 6aaa1f81-ba97-4256-9edc-919267c28d3c"}
{"timestamp": "2026-02-16T08:40:30.741593Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  production_line_id: f529f429-f93e-4c65-9347-dad986ccec2e"}
{"timestamp": "2026-02-16T08:40:30.741622Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  factory_id: None"}
{"timestamp": "2026-02-16T08:40:30.741649Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  data_source_id: None"}
{"timestamp": "2026-02-16T08:40:30.741677Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  mappings count: 1"}
{"timestamp": "2026-02-16T08:40:30.741703Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "============================================================"}
{"timestamp": "2026-02-16T08:40:30.745713Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "Schema Locked for DataSource f529f429-f93e-4c65-9347-dad986ccec2e: dict_keys(['style'])"}
{"timestamp": "2026-02-16T08:40:30.753919Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/confirm-mapping \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-02-16T08:40:30.757970Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/api/v1/ingestion/uploads?production_line_id=f529f429-f93e-4c65-9347-dad986ccec2e \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-02-16T08:40:30.758491Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/api/v1/datasources/f529f429-f93e-4c65-9347-dad986ccec2e \"HTTP/1.1 404 Not Found\""}
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/upload?factory_id=df1aa679-af47-46f9-9ee7-1639e95aa989&production_line_id=f529f429-f93e-4c65-9347-dad986ccec2e "HTTP/1.1 200 OK"
INFO     ingestion.confirm_mapping:ingestion.py:525 ============================================================
INFO     ingestion.confirm_mapping:ingestion.py:526 CONFIRM-MAPPING ENDPOINT CALLED
INFO     ingestion.confirm_mapping:ingestion.py:527   raw_import_id: 6aaa1f81-ba97-4256-9edc-919267c28d3c
INFO     ingestion.confirm_mapping:ingestion.py:528   production_line_id: f529f429-f93e-4c65-9347-dad986ccec2e
INFO     ingestion.confirm_mapping:ingestion.py:529   factory_id: None
INFO     ingestion.confirm_mapping:ingestion.py:530   data_source_id: None
INFO     ingestion.confirm_mapping:ingestion.py:531   mappings count: 1
INFO     ingestion.confirm_mapping:ingestion.py:532 ============================================================
INFO     ingestion.confirm_mapping:ingestion.py:626 Schema Locked for DataSource f529f429-f93e-4c65-9347-dad986ccec2e: dict_keys(['style'])
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/confirm-mapping "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: GET http://test/api/v1/ingestion/uploads?production_line_id=f529f429-f93e-4c65-9347-dad986ccec2e "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: GET http://test/api/v1/datasources/f529f429-f93e-4c65-9347-dad986ccec2e "HTTP/1.1 404 Not Found"
_______________________ test_reset_schema_configuration _______________________
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:1815: in _execute_context
    context = constructor(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\default.py:1496: in _init_compiled
    flattened_processors[key](compiled_params[key])
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\dialects\sqlite\base.py:1207: in process
    raise TypeError(
E   TypeError: SQLite DateTime type only accepts Python datetime and date objects as input.

The above exception was the direct cause of the following exception:
backend\tests\test_api\test_line_management.py:63: in test_reset_schema_configuration
    await db_session.commit()
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\ext\asyncio\session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:1286: in _prepare_impl
    self.session.flush()
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:4331: in flush
    self._flush(objects)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:4466: in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:4427: in _flush
    flush_context.execute()
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\unitofwork.py:466: in execute
    rec.execute(self)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\persistence.py:93: in save_obj
    _emit_insert_statements(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\sql\elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:1821: in _execute_context
    self._handle_dbapi_exception(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:1815: in _execute_context
    context = constructor(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\default.py:1496: in _init_compiled
    flattened_processors[key](compiled_params[key])
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\dialects\sqlite\base.py:1207: in process
    raise TypeError(
E   sqlalchemy.exc.StatementError: (builtins.TypeError) SQLite DateTime type only accepts Python datetime and date objects as input.
E   [SQL: INSERT INTO production_runs (factory_id, order_id, data_source_id, source_import_id, production_date, inspection_date, shift, planned_qty, actual_qty, wip_start, wip_end, lot_number, shade_band, batch_number, downtime_minutes, downtime_reason, sam, operators_present, helpers_present, worked_minutes, notes, start_time, end_time, style_number, buyer, season, po_number, color, size, defects, dhu, line_efficiency, id, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING earned_minutes, efficiency]
E   [parameters: [{'actual_qty': 100, 'production_date': '2026-01-01', 'shift': 'day', 'factory_id': 'b6b49d6e-c6b4-4d19-ad16-b8eefdf2af01', 'data_source_id': 'df8d9ea6 ... (324 characters truncated) ... e, 'end_time': None, 'start_time': None, 'line_efficiency': None, 'size': None, 'notes': None, 'po_number': None, 'wip_start': None, 'order_id': None}]]
__________________________ test_clear_upload_history __________________________
backend\tests\test_api\test_line_management.py:129: in test_clear_upload_history
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = <Response [404 Not Found]>.status_code
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-16T08:40:32.070018Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: DELETE http://test/api/v1/datasources/4d0bcdb8-477e-4a93-8b69-824aff7b85b0 \"HTTP/1.1 404 Not Found\""}
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: DELETE http://test/api/v1/datasources/4d0bcdb8-477e-4a93-8b69-824aff7b85b0 "HTTP/1.1 404 Not Found"
=========================== short test summary info ===========================
FAILED backend\tests\test_api\test_preview.py::test_list_uploads_includes_datasource_id
FAILED backend\tests\test_api\test_line_management.py::test_reset_schema_configuration
FAILED backend\tests\test_api\test_line_management.py::test_clear_upload_history
========================= 3 failed, 8 passed in 6.16s =========================
