============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- C:\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\19803\Projects\FactoryExcelManager\backend
configfile: pytest.ini
plugins: anyio-4.12.0, Faker-40.1.0, langsmith-0.5.1, locust-2.43.0, asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 11 items

backend\tests\test_api\test_preview.py::test_preview_endpoint_success {"timestamp": "2026-02-16T08:42:48.728412Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/upload?factory_id=1559d171-49ff-4745-af13-5d270ad4b1e2&production_line_id=0beb9246-0252-4284-9022-088c57ace27f \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-02-16T08:42:49.034424Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'style_number' -> 'style_number' (Conf: 1.0)"}
{"timestamp": "2026-02-16T08:42:49.034570Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'po_number' -> 'po_number' (Conf: 1.0)"}
{"timestamp": "2026-02-16T08:42:49.034638Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'quantity' -> 'actual_qty' (Conf: 1.0)"}
{"timestamp": "2026-02-16T08:42:49.034697Z", "level": "INFO", "logger": "app.services.matching.engine", "message": "MATCH [Hash]: 'date' -> 'production_date' (Conf: 1.0)"}
{"timestamp": "2026-02-16T08:42:49.043217Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/process/39209c24-e520-4911-9a19-aa46a271122e \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-02-16T08:42:49.048728Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/api/v1/ingestion/preview/39209c24-e520-4911-9a19-aa46a271122e \"HTTP/1.1 200 OK\""}
PASSED
backend\tests\test_api\test_preview.py::test_list_uploads_includes_datasource_id {"timestamp": "2026-02-16T08:42:49.392964Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/upload?factory_id=f360b1d9-c70c-46fd-a6e8-443353cc2101&production_line_id=c4a13527-c4d4-4da1-a7db-e1a366597a00 \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-02-16T08:42:49.395162Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "============================================================"}
{"timestamp": "2026-02-16T08:42:49.395333Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "CONFIRM-MAPPING ENDPOINT CALLED"}
{"timestamp": "2026-02-16T08:42:49.395405Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  raw_import_id: 701b512f-6b99-44ed-862e-ad20d513e204"}
{"timestamp": "2026-02-16T08:42:49.395460Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  production_line_id: c4a13527-c4d4-4da1-a7db-e1a366597a00"}
{"timestamp": "2026-02-16T08:42:49.395500Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  factory_id: None"}
{"timestamp": "2026-02-16T08:42:49.395547Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  data_source_id: None"}
{"timestamp": "2026-02-16T08:42:49.395585Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "  mappings count: 1"}
{"timestamp": "2026-02-16T08:42:49.395631Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "============================================================"}
{"timestamp": "2026-02-16T08:42:49.401152Z", "level": "INFO", "logger": "ingestion.confirm_mapping", "message": "Schema Locked for DataSource c4a13527-c4d4-4da1-a7db-e1a366597a00: dict_keys(['style'])"}
{"timestamp": "2026-02-16T08:42:49.412806Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST http://test/api/v1/ingestion/confirm-mapping \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-02-16T08:42:49.417730Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/api/v1/ingestion/uploads?production_line_id=c4a13527-c4d4-4da1-a7db-e1a366597a00 \"HTTP/1.1 200 OK\""}
DEBUG: Fetching DataSource c4a13527-c4d4-4da1-a7db-e1a366597a00, Line ID: c4a13527-c4d4-4da1-a7db-e1a366597a00
{"timestamp": "2026-02-16T08:42:49.418348Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/api/v1/datasources/c4a13527-c4d4-4da1-a7db-e1a366597a00 \"HTTP/1.1 404 Not Found\""}
DEBUG: DS Response (404): {"detail":"Not Found"}
FAILED
backend\tests\test_api\test_line_management.py::test_reset_schema_configuration FAILED
backend\tests\test_api\test_line_management.py::test_clear_upload_history {"timestamp": "2026-02-16T08:42:50.793817Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: DELETE http://test/api/v1/datasources/66e2bfc2-516b-4661-a28e-342793057056 \"HTTP/1.1 404 Not Found\""}
FAILED
backend\tests\api\v1\test_users.py::test_get_user_me {"timestamp": "2026-02-16T08:42:51.128817Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/api/v1/users/me \"HTTP/1.1 200 OK\""}
PASSED
backend\tests\api\v1\test_users.py::test_update_user_me {"timestamp": "2026-02-16T08:42:51.491634Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: PATCH http://test/api/v1/users/me \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-02-16T08:42:51.495661Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/api/v1/users/me \"HTTP/1.1 200 OK\""}
PASSED
backend\tests\api\v1\test_users.py::test_update_user_invalid_timezone {"timestamp": "2026-02-16T08:42:51.848744Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: PATCH http://test/api/v1/users/me \"HTTP/1.1 422 Unprocessable Entity\""}
PASSED
backend\tests\api\v1\test_users.py::test_update_user_partial_preferences {"timestamp": "2026-02-16T08:42:52.204879Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: PATCH http://test/api/v1/users/me \"HTTP/1.1 200 OK\""}
{"timestamp": "2026-02-16T08:42:52.212678Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: PATCH http://test/api/v1/users/me \"HTTP/1.1 200 OK\""}
PASSED
backend\tests\api\v1\test_users.py::test_update_user_invalid_preference_type {"timestamp": "2026-02-16T08:42:52.550329Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: PATCH http://test/api/v1/users/me \"HTTP/1.1 422 Unprocessable Entity\""}
PASSED
backend\tests\api\test_analytics_flaws.py::test_hourly_production_no_events_returns_zeros 
DEBUG: Starting test_hourly_production_no_events_returns_zeros
DEBUG: Run added to session
DEBUG: Run committed
DEBUG: Calling API /api/v1/analytics/production/hourly
DEBUG: Entering get_hourly_production line_id=5d56555b-59c4-4faf-9e55-5bc3d2119c19
DEBUG: Calling prod_repo.get_effective_date
DEBUG: effective_date=2026-02-16
DEBUG: Executing query
DEBUG: Query executed
DEBUG: Found 0 rows
{"timestamp": "2026-02-16T08:42:52.997381Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET http://test/api/v1/analytics/production/hourly?line_id=5d56555b-59c4-4faf-9e55-5bc3d2119c19 \"HTTP/1.1 200 OK\""}
DEBUG: API Response Status: 200
DEBUG: API Response Data: [0,0,0,0,0,0,0,0,0,0,0,0]
PASSED
backend\tests\api\test_analytics_flaws.py::test_midnight_boundary_respects_timezone 
DEBUG: Starting test_midnight_boundary_respects_timezone
DEBUG: Factory Today: 2026-02-16
DEBUG: Effective Date 1: 2026-02-16
DEBUG: Effective Date 2: 2026-02-17
PASSED

================================== FAILURES ===================================
__________________ test_list_uploads_includes_datasource_id ___________________
backend\tests\test_api\test_preview.py:142: in test_list_uploads_includes_datasource_id
    assert ds_res.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/upload?factory_id=f360b1d9-c70c-46fd-a6e8-443353cc2101&production_line_id=c4a13527-c4d4-4da1-a7db-e1a366597a00 "HTTP/1.1 200 OK"
INFO     ingestion.confirm_mapping:ingestion.py:525 ============================================================
INFO     ingestion.confirm_mapping:ingestion.py:526 CONFIRM-MAPPING ENDPOINT CALLED
INFO     ingestion.confirm_mapping:ingestion.py:527   raw_import_id: 701b512f-6b99-44ed-862e-ad20d513e204
INFO     ingestion.confirm_mapping:ingestion.py:528   production_line_id: c4a13527-c4d4-4da1-a7db-e1a366597a00
INFO     ingestion.confirm_mapping:ingestion.py:529   factory_id: None
INFO     ingestion.confirm_mapping:ingestion.py:530   data_source_id: None
INFO     ingestion.confirm_mapping:ingestion.py:531   mappings count: 1
INFO     ingestion.confirm_mapping:ingestion.py:532 ============================================================
INFO     ingestion.confirm_mapping:ingestion.py:626 Schema Locked for DataSource c4a13527-c4d4-4da1-a7db-e1a366597a00: dict_keys(['style'])
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/v1/ingestion/confirm-mapping "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: GET http://test/api/v1/ingestion/uploads?production_line_id=c4a13527-c4d4-4da1-a7db-e1a366597a00 "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: GET http://test/api/v1/datasources/c4a13527-c4d4-4da1-a7db-e1a366597a00 "HTTP/1.1 404 Not Found"
_______________________ test_reset_schema_configuration _______________________
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:1967: in _exec_single_context
    self.dialect.do_execute(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\default.py:952: in do_execute
    cursor.execute(statement, parameters)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:340: in _handle_exception
    raise error
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\aiosqlite\cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
..\..\AppData\Roaming\Python\Python313\site-packages\aiosqlite\cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\aiosqlite\core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\aiosqlite\core.py:63: in _connection_worker_thread
    result = function()
             ^^^^^^^^^^
E   sqlite3.IntegrityError: NOT NULL constraint failed: production_runs.order_id

The above exception was the direct cause of the following exception:
backend\tests\test_api\test_line_management.py:64: in test_reset_schema_configuration
    await db_session.commit()
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\ext\asyncio\session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:1286: in _prepare_impl
    self.session.flush()
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:4331: in flush
    self._flush(objects)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:4466: in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\session.py:4427: in _flush
    flush_context.execute()
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\unitofwork.py:466: in execute
    rec.execute(self)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\persistence.py:93: in save_obj
    _emit_insert_statements(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\orm\persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\sql\elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:1846: in _execute_context
    return self._exec_single_context(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\base.py:1967: in _exec_single_context
    self.dialect.do_execute(
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\engine\default.py:952: in do_execute
    cursor.execute(statement, parameters)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:340: in _handle_exception
    raise error
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\aiosqlite\cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
..\..\AppData\Roaming\Python\Python313\site-packages\aiosqlite\cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\aiosqlite\core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
..\..\AppData\Roaming\Python\Python313\site-packages\aiosqlite\core.py:63: in _connection_worker_thread
    result = function()
             ^^^^^^^^^^
E   sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) NOT NULL constraint failed: production_runs.order_id
E   [SQL: INSERT INTO production_runs (factory_id, order_id, data_source_id, source_import_id, production_date, inspection_date, shift, planned_qty, actual_qty, wip_start, wip_end, lot_number, shade_band, batch_number, downtime_minutes, downtime_reason, sam, operators_present, helpers_present, worked_minutes, notes, start_time, end_time, style_number, buyer, season, po_number, color, size, defects, dhu, line_efficiency, id, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING earned_minutes, efficiency]
E   [parameters: ('87587b00-00fc-450a-8e2d-8aa09cc1b73e', None, '340afc98-b4cb-47cd-ab26-b36913039b04', None, '2026-01-01 00:00:00.000000', None, 'day', None, 100, None, None, None, None, None, None, None, None, 0, 0, 0.0, None, None, None, None, None, None, None, None, None, 0, None, None, '4305e0b6-ee35-42bc-a41d-d18928a905ed', '2026-02-16 08:42:50.141900', '2026-02-16 08:42:50.141902')]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
__________________________ test_clear_upload_history __________________________
backend\tests\test_api\test_line_management.py:130: in test_clear_upload_history
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = <Response [404 Not Found]>.status_code
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: DELETE http://test/api/v1/datasources/66e2bfc2-516b-4661-a28e-342793057056 "HTTP/1.1 404 Not Found"
=========================== short test summary info ===========================
FAILED backend\tests\test_api\test_preview.py::test_list_uploads_includes_datasource_id
FAILED backend\tests\test_api\test_line_management.py::test_reset_schema_configuration
FAILED backend\tests\test_api\test_line_management.py::test_clear_upload_history
========================= 3 failed, 8 passed in 6.46s =========================
